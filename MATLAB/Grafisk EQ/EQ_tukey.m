%% Jämför av idealt frekvenssvar och det approximerade frekvenssvaret med eller utan fönsterfunkton.
%  Fönster av typ Hamming och Blackman
clear all

% Rounding options
%   round(A) - rounds the elements of A to the nearest integers
%   fix(A) - rounds the elements of A toward zero
%   floor(A) - rounds the elements of A to the nearest integers less than or equal to A 
%   ceil(A) - rounds the elements of A to the nearest integers greater than or equal to A
rounding = @round;

%% Skapar idealt frekvenssvar
N = 8*512;%4*2048; %Length of filter, even!
g = N/2; %Group delay
fs=48000; %Sample rate for wav

%Phase part
k=0:g-1;
phase = zeros(1,g);
for i=1:g/2
    phase(2*i-1)=1;
    phase(2*i)=-1;
end

%Frequency response
% uint8 = 0 to 255
a = [ 200 40 255 150 0 255 100 150];
a = a*128;
fref=130; %Hz
n=0:6; 
fc=fref.*2.^n;
fc=fc./fs;
fc = int16(rounding(fc .* 2^15)); %Q15

A=zeros(1,g);

dF = int16(rounding(1/N .* 2^15)); %Q15
c=0;
for i=1:g
    x=(i-1)*dF;
    if (x<fc(1))
        A(i)=a(1);
    elseif (x<fc(2))
        A(i)=a(2);
    elseif (x<fc(3))
        A(i)=a(3);
    elseif (x<fc(4))
        A(i)=a(4);
    elseif (x<fc(5))
        A(i)=a(5);
    elseif (x<fc(6))
        A(i)=a(6);
    elseif (x<fc(7))
        A(i)=a(7);
    elseif (x<13763)
        A(i)=a(8);
    else
        A(i)=0;
    end
end

f=linspace(0,fs/2,N/2);

%% Frekvenssvar beräknade på DSPn

%Tukey
Htur=[0, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0, -1, 0, -2, -1, -3, -5, -4, -6, -3, -5, -4, -4, -7, -2, -7, -4, -8, -8, -2, -4, 7, 2, 7, 5, 1, 6, -9, -6, -21, -21, -18, -24, -9, -24, -13, -19, -18, -8, -25, -8, -22, -1, 11, 17, 42, 23, 47, 29, 33, 30, -2, 11, -23, 4, 0, 4, 22, -9, 26, -3, 18, 9, -12, 19, -7, 53, 45, 65, 74, 36, 70, 11, 27, -23, -56, -42, -84, -17, -52, -19, -24, -45, 10, -40, 18, -24, -2, 43, 42, 147, 107, 168, 137, 124, 154, 66, 104, 4, 27, 32, 26, 112, 40, 113, 59, 84, 113, 50, 121, 33, 126, 139, 174, 250, 161, 234, 126, 147, 102, 3, 29, -101, 0, -33, 20, 66, -9, 97, 5, 106, 73, 56, 130, 64, 246, 217, 316, 316, 237, 307, 153, 220, 78, 32, 28, -62, 94, 5, 112, 56, 21, 99, -21, 103, -35, 13, 30, 16, 198, 83, 200, 58, 23, 15, -164, -99, -341, -283, -333, -311, -148, -267, -94, -236, -138, -106, -174, -20, -196, 20, 5, 146, 289, 149, 300, 43, 132, 0, -136, -106, -388, -163, -281, -90, -32, -158, 34, -218, 32, -113, -102, -25, -211, 177, 35, 342, 246, 81, 166, -268, -49, -495, -518, -626, -830, -341, -566, -37, -237, -175, 59, -232, 384, -94, 337, 312, 468, 1342, 1010, 1881, 1097, 1192, 991, 121, 669, -1200, -572, -1667, -1211, 444, -996, 2633, -2332, 2558, 15530, 2558, -2333, 2633, -997, 444, -1211, -1667, -572, -1201, 670, 121, 992, 1191, 1098, 1881, 1010, 1342, 469, 312, 336, -94, 384, -232, 60, -176, -237, -37, -566, -341, -830, -626, -517, -494, -49, -268, 166, 81, 246, 342, 36, 178, -211, -25, -103, -114, 32, -218, 35, -158, -32, -89, -281, -163, -387, -106, -136, 1, 132, 43, 301, 150, 289, 146, 5, 20, -195, -20, -174, -106, -139, -236, -94, -267, -147, -311, -332, -282, -340, -99, -164, 16, 23, 58, 200, 84, 198, 16, 30, 13, -35, 104, -22, 99, 21, 56, 112, 5, 95, -62, 28, 32, 78, 221, 154, 307, 237, 315, 315, 216, 245, 64, 130, 56, 73, 106, 5, 97, -9, 66, 20, -33, 0, -101, 30, 3, 102, 146, 125, 232, 161, 249, 173, 138, 126, 33, 120, 48, 113, 84, 59, 112, 40, 111, 26, 33, 28, 4, 103, 66, 152, 123, 136, 165, 107, 146, 41, 42, -2, -24, 17, -40, 10, -44, -24, -19, -51, -16, -82, -41, -54, -22, 26, 11, 69, 35, 72, 64, 44, 52, -7, 19, -11, 9, 18, -3, 25, -8, 22, 4, 1, 4, -22, 11, -2, 29, 32, 29, 45, 22, 41, 16, 11, -1, -21, -8, -24, -8, -17, -18, -12, -23, -9, -23, -17, -20, -20, -6, -9, 6, 1, 5, 6, 2, 6, -4, -2, -8, -8, -4, -7, -2, -6, -4, -4, -5, -3, -5, -3, -4, -2, -1, -1, 0, -1, 0, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0];
Htur = double(Htur)*2^-15;
[htur, f] =freqz(Htur,1,N/2,fs);

%No window
H=[-231, -156, -204, -183, -181, -231, -149, -182, -71, -62, -38, 7, -48, 25, -50, -34, -83, -138, -90, -147, -56, -97, -76, -61, -103, -28, -101, -52, -95, -89, -20, -39, 70, 19, 62, 46, 10, 47, -62, -37, -129, -123, -98, -129, -46, -120, -60, -87, -79, -33, -102, -30, -85, -3, 42, 61, 145, 77, 150, 92, 100, 89, -5, 31, -61, 13, 2, 12, 55, -20, 61, -5, 40, 21, -24, 40, -13, 107, 89, 125, 139, 67, 127, 20, 47, -39, -93, -69, -135, -27, -81, -29, -36, -67, 16, -58, 26, -34, -2, 60, 58, 199, 144, 222, 180, 161, 197, 84, 131, 6, 34, 40, 32, 134, 48, 133, 69, 97, 130, 57, 137, 38, 140, 154, 191, 273, 175, 252, 135, 157, 109, 4, 31, -105, 1, -34, 21, 68, -9, 100, 6, 108, 74, 57, 132, 65, 248, 218, 317, 317, 238, 308, 154, 221, 79, 33, 29, -62, 95, 6, 113, 57, 22, 100, -21, 104, -35, 14, 31, 17, 199, 84, 201, 59, 24, 16, -164, -99, -341, -283, -333, -311, -148, -267, -94, -236, -138, -106, -174, -20, -196, 21, 6, 147, 290, 150, 301, 44, 133, 1, -136, -106, -388, -163, -281, -90, -32, -158, 35, -218, 33, -113, -102, -25, -211, 178, 36, 343, 247, 82, 167, -268, -49, -495, -518, -626, -830, -341, -566, -37, -237, -175, 60, -232, 385, -94, 338, 313, 469, 1343, 1011, 1882, 1098, 1193, 992, 122, 670, -1200, -572, -1667, -1211, 445, -996, 2634, -2332, 2559, 15531, 2559, -2333, 2634, -997, 445, -1211, -1667, -572, -1201, 671, 122, 993, 1192, 1099, 1882, 1011, 1343, 470, 313, 337, -94, 385, -232, 61, -176, -237, -37, -566, -341, -830, -626, -517, -494, -49, -268, 167, 82, 247, 343, 37, 179, -211, -25, -103, -114, 33, -218, 36, -158, -32, -89, -281, -163, -387, -106, -136, 2, 133, 44, 302, 151, 290, 147, 6, 21, -195, -20, -174, -106, -139, -236, -94, -267, -147, -311, -332, -282, -340, -99, -164, 17, 24, 59, 201, 85, 199, 17, 31, 14, -35, 105, -22, 100, 22, 57, 113, 6, 96, -62, 29, 33, 79, 222, 155, 308, 238, 316, 317, 218, 247, 65, 132, 57, 75, 109, 6, 100, -9, 69, 21, -34, 1, -105, 32, 4, 109, 157, 135, 252, 176, 273, 191, 154, 141, 38, 137, 56, 131, 98, 70, 133, 48, 134, 32, 41, 35, 6, 131, 85, 197, 161, 180, 221, 146, 200, 58, 60, -2, -34, 26, -58, 16, -66, -36, -29, -81, -26, -135, -68, -92, -37, 47, 21, 127, 67, 139, 126, 89, 107, -13, 41, -23, 22, 41, -5, 61, -19, 55, 12, 3, 13, -60, 32, -4, 89, 101, 93, 151, 78, 147, 61, 42, -2, -84, -30, -102, -33, -78, -86, -59, -119, -45, -127, -98, -122, -129, -36, -61, 48, 10, 47, 63, 20, 70, -39, -20, -88, -94, -51, -101, -27, -103, -61, -75, -97, -55, -145, -90, -137, -82, -33, -50, 27, -48, 8, -38, -61, -70, -180, -148, -230, -180, -182, -203, -156];
H = double(H)*2^-15;
[H, f] =freqz(H,1,N/2,fs);  

clear fig
hold all
plot(f,abs(htur), 'LineWidth',2)
plot(f,A/32767,'r', 'LineWidth',1);
axis([0 9000 0 1.2])
xlabel('Frekvens')
ylabel('Magnitud')
title('Frekvenssvar: Grafisk EQ','FontWeight','bold')
